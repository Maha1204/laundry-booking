<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tvättstuga Bokning</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- COLOR PALETTE: "Clean Night" --- */
            --bg-color: #0B1120;
            --card-bg: #151E32;
            --border-color: #2D3A54;
            --primary: #38bdf8;
            --primary-hover: #0ea5e9;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            
            /* Booked State */
            --booked-bg: #1e293b;
            --booked-border: #334155;
            --booked-text: #64748b;
            
            /* Delete/Danger */
            --danger: #ef4444;
            --danger-hover: #f87171;
            
            /* Alert/Rules */
            --warning-bg: #422006;
            --warning-text: #fbbf24;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px 15px; /* Reduced padding */
        }

        .container {
            max-width: 1400px; /* Increased width for better table fit */
            margin: 0 auto;
        }

        /* --- Header --- */
        header { 
            text-align: center; 
            margin-bottom: 20px; /* Reduced from 40px */
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 15px;
        }
        header h1 { font-size: 1.8em; color: var(--text-main); letter-spacing: -0.5px; }
        header p { color: var(--text-muted); font-size: 1em; }

        /* --- Rules Section --- */
        .rules-banner {
            background: rgba(251, 191, 36, 0.05);
            border: 1px solid rgba(251, 191, 36, 0.2);
            color: var(--warning-text);
            padding: 10px 16px; /* Reduced padding */
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.9em;
        }

        /* --- Calendar Controls --- */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background: var(--card-bg);
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        
        .week-btn {
            background: transparent;
            color: var(--primary);
            border: 1px solid transparent;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .week-btn:hover { background: rgba(56, 189, 248, 0.1); }
        
        #currentWeekDisplay { font-size: 1em; font-weight: 600; color: var(--text-main); }

        /* --- Calendar Grid --- */
        .calendar-wrapper {
            overflow-x: auto;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .calendar-grid {
            display: grid;
            /* ADJUSTMENT: Smaller time column (60px) and responsive day columns */
            grid-template-columns: 60px repeat(7, minmax(110px, 1fr));
            gap: 1px;
            background: var(--border-color);
        }

        .grid-header, .grid-time, .grid-cell {
            background: var(--card-bg);
            padding: 10px 6px; /* Tighter padding */
            text-align: center;
        }

        .grid-header {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        .grid-time {
            font-weight: 500;
            color: var(--text-muted);
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Slot Styles --- */
        .slot-btn {
            width: 100%; 
            padding: 8px; 
            border-radius: 6px;
            font-size: 0.85em; 
            font-weight: 500; 
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            border: 1px dashed rgba(56, 189, 248, 0.3); /* Dashed looks lighter */
            color: var(--primary);
            height: 100%;
            min-height: 50px; /* Ensures clickability */
        }

        .slot-btn:hover {
            background: var(--primary); 
            color: #0f172a;
            border-style: solid;
            border-color: var(--primary);
        }

        /* --- Booked Card with Delete --- */
        .slot-card {
            background: var(--booked-bg);
            color: var(--booked-text);
            padding: 8px;
            padding-right: 20px; /* Space for X button */
            border-radius: 6px;
            font-size: 0.8em;
            text-align: left;
            border: 1px solid var(--booked-border);
            height: 100%;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .slot-card strong { display: block; margin-bottom: 2px; color: var(--text-muted); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .slot-card span { font-size: 0.9em; display: block; white-space: nowrap; }

        /* The Delete (Unbook) Button */
        .unbook-btn {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 20px;
            background: rgba(255,255,255,0.03);
            border: none;
            border-left: 1px solid var(--booked-border);
            color: var(--danger);
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .unbook-btn:hover {
            background: rgba(239, 68, 68, 0.15);
        }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(11, 17, 32, 0.85);
            display: none; justify-content: center; align-items: center;
            z-index: 100; backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg); padding: 24px; border-radius: 12px;
            width: 90%; max-width: 350px; /* Smaller modal */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
        }

        .modal-header { margin-bottom: 20px; text-align: center; }
        .modal-header h2 { color: var(--text-main); font-size: 1.3em; margin-bottom: 5px; }
        .modal-header p { color: var(--primary); font-weight: 500; font-size: 0.9em; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; color: var(--text-muted); font-size: 0.85em; }
        .form-group input {
            width: 100%; padding: 10px; background: var(--bg-color); 
            border: 1px solid var(--border-color); color: white; border-radius: 6px; font-size: 0.95em;
        }
        .form-group input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2); }

        .btn-primary {
            width: 100%; padding: 12px; background: var(--primary); color: #0f172a;
            border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.95em;
        }
        .btn-cancel {
            width: 100%; padding: 10px; margin-top: 5px; background: transparent; 
            color: var(--text-muted); border: none; cursor: pointer; font-size: 0.9em;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Tvättstugan</h1>
            <p style="align-self: center;">Bokning</p>
        </header>

        <div class="rules-banner">
            <span style="font-size: 1.2em;">ℹ️</span>
            <div>
                Lämna tvättstugan ren och fin. Respektera tiderna.
            </div>
        </div>

        <div class="calendar-controls">
            <button class="week-btn" onclick="changeWeek(-1)">← Föregående</button>
            <span id="currentWeekDisplay">Vecka ...</span>
            <button class="week-btn" onclick="changeWeek(1)">Nästa →</button>
        </div>

        <div class="calendar-wrapper">
            <div id="calendarGrid" class="calendar-grid">
                </div>
        </div>
    </div>

    <div id="bookingModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Boka Tid</h2>
                <p id="modalDateDisplay"></p>
            </div>
            <form id="bookingForm">
                <input type="hidden" id="selectedDate">
                <input type="hidden" id="selectedTime">
                
                <div class="form-group">
                    <label>Ditt Namn</label>
                    <input type="text" id="name" placeholder="Förnamn Efternamn" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label>Lägenhetsnummer</label>
                    <input type="text" id="apartment" placeholder="T.ex. 1201" required autocomplete="off">
                </div>
                <button type="submit" class="btn-primary">Bekräfta</button>
                <button type="button" class="btn-cancel" onclick="closeModal()">Avbryt</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://https://ma120444.pythonanywhere.com//api';
        // Now only using the short labels as per your image and backend logic
        const timeSlots = ['07-10', '10-13', '13-16', '16-19', '19-22'];
        let currentWeekStart = new Date();
        let allBookings = [];

        // Adjust to Monday
        const day = currentWeekStart.getDay(); 
        const diff = currentWeekStart.getDate() - day + (day == 0 ? -6 : 1);
        currentWeekStart.setDate(diff);

        async function init() {
            await fetchBookings();
            renderCalendar();
        }

        async function fetchBookings() {
            try {
                const response = await fetch(`${API_URL}/bookings`);
                allBookings = await response.json();
            } catch (error) {
                console.error('Error fetching bookings:', error);
            }
        }

        function changeWeek(offset) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (offset * 7));
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const weekDates = [];
            const tempDate = new Date(currentWeekStart);
            const swedishDays = ['MÅN', 'TIS', 'ONS', 'TOR', 'FRE', 'LÖR', 'SÖN'];
            
            const endDate = new Date(tempDate);
            endDate.setDate(endDate.getDate() + 6);
            document.getElementById('currentWeekDisplay').textContent = 
                `v.${getWeekNumber(tempDate)} (${formatDateReadable(tempDate)} - ${formatDateReadable(endDate)})`;

            // Header
            grid.appendChild(createCell('div', 'grid-header', 'TID'));
            for (let i = 0; i < 7; i++) {
                // Ensure date object is set for the start of the current day for accurate date math
                const currentDate = new Date(tempDate);
                
                // ADJUSTMENT: Use the uppercase Swedish day name from the array for the header
                const dayName = swedishDays[i]; 
                
                // Format: MÅN 24/11
                const displayDate = `${dayName} ${currentDate.getDate()}/${currentDate.getMonth() + 1}`;
                
                weekDates.push({ 
                    date: currentDate.toISOString().split('T')[0], 
                    display: displayDate 
                });
                grid.appendChild(createCell('div', 'grid-header', displayDate));
                tempDate.setDate(tempDate.getDate() + 1);
            }

            // Time slots
            // Iterating directly over the desired display time slots
            timeSlots.forEach(timeSlot => {
                const shortTime = timeSlot; // This is the '07-10', '10-13', etc.
                grid.appendChild(createCell('div', 'grid-time', shortTime));

                weekDates.forEach(dayObj => {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    
                    // Check for booking using the *short time slot* which is stored in the DB
                    const booking = allBookings.find(b => b.date === dayObj.date && b.time === shortTime);
                    const isPastDate = new Date(dayObj.date) < new Date().setHours(0,0,0,0);
                    
                    if (booking) {
                        cell.innerHTML = `
                            <div class="slot-card">
                                <button class="unbook-btn" onclick="deleteBooking(${booking.id})" title="Avboka">×</button>
                                <strong>${booking.name}</strong>
                                <span>${booking.apartment}</span>
                            </div>
                        `;
                    } else if (isPastDate) {
                         cell.innerHTML = `<span style="color:#334155; font-size:1.2em;">-</span>`;
                    } else {
                        const btn = document.createElement('button');
                        btn.className = 'slot-btn';
                        btn.textContent = '+';
                        // Use the short time slot for opening the modal
                        btn.onclick = () => openModal(dayObj.date, shortTime);
                        cell.appendChild(btn);
                    }
                    grid.appendChild(cell);
                });
            });
        }

        function createCell(tag, className, content) {
            const el = document.createElement(tag);
            el.className = className;
            el.textContent = content;
            return el;
        }

        function formatDateReadable(date) {
            return `${date.getDate()}/${date.getMonth() + 1}`;
        }
        
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        }

        // --- Booking Actions ---

        const modal = document.getElementById('bookingModal');

        function openModal(date, time) {
            document.getElementById('selectedDate').value = date;
            document.getElementById('selectedTime').value = time;
            document.getElementById('modalDateDisplay').textContent = `${date} • ${time}`;
            modal.style.display = 'flex';
            document.getElementById('name').focus();
        }

        function closeModal() {
            modal.style.display = 'none';
            document.getElementById('bookingForm').reset();
        }

        document.getElementById('bookingForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('name').value,
                apartment: document.getElementById('apartment').value,
                date: document.getElementById('selectedDate').value,
                // Time is now guaranteed to be the short format (e.g., '07-10')
                time: document.getElementById('selectedTime').value 
            };

            try {
                const response = await fetch(`${API_URL}/bookings`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal();
                    await fetchBookings();
                    renderCalendar();
                } else {
                    const err = await response.json();
                    alert(err.error || 'Fel vid bokning');
                }
            } catch (error) {
                alert('Kunde inte ansluta till servern');
            }
        };

        async function deleteBooking(id) {
            if (!confirm('Vill du verkligen avboka denna tid?')) return;
            
            try {
                const response = await fetch(`${API_URL}/bookings/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    await fetchBookings(); 
                    renderCalendar();     
                } else {
                    alert('Kunde inte avboka.');
                }
            } catch (error) {
                alert('Serverfel vid avbokning.');
            }
        }

        modal.onclick = (e) => { if (e.target === modal) closeModal(); }
        init();
    </script>
</body>
</html>
